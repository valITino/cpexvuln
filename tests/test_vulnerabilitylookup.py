import pathlib
import sys
from datetime import datetime, timedelta, timezone

ROOT = pathlib.Path(__file__).resolve().parents[1]
if str(ROOT) not in sys.path:
    sys.path.insert(0, str(ROOT))

from app import vulnerabilitylookup


def test_extract_metrics_cvss_v31():
    vuln = {
        "cvss-metrics": [
            {
                "cvssV3_1": {
                    "version": "3.1",
                    "baseScore": 7.5,
                    "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N",
                    "baseSeverity": "HIGH"
                }
            }
        ]
    }
    result = vulnerabilitylookup.extract_metrics(vuln)
    assert result["version"] == "3.1"
    assert result["baseScore"] == 7.5
    assert result["baseSeverity"] == "HIGH"


def test_extract_metrics_prefers_v4():
    vuln = {
        "cvss-metrics": [
            {
                "cvssV3_1": {
                    "version": "3.1",
                    "baseScore": 7.5,
                    "vectorString": "CVSS:3.1/...",
                    "baseSeverity": "High"
                }
            },
            {
                "cvssV4_0": {
                    "version": "4.0",
                    "baseScore": 8.3,
                    "vectorString": "CVSS:4.0/...",
                    "baseSeverity": "Critical"
                }
            }
        ]
    }
    result = vulnerabilitylookup.extract_metrics(vuln)
    assert result["version"] == "4.0"
    assert result["baseScore"] == 8.3
    assert result["baseSeverity"] == "Critical"


def test_extract_epss():
    vuln = {
        "epss": {
            "epss": 0.75123,
            "percentile": 0.95432
        }
    }
    result = vulnerabilitylookup.extract_epss(vuln)
    assert result["score"] == 0.75123
    assert result["percentile"] == 0.95432


def test_extract_epss_missing():
    vuln = {}
    result = vulnerabilitylookup.extract_epss(vuln)
    assert result["score"] is None
    assert result["percentile"] is None


def test_is_kev_true():
    vuln = {
        "kev": {
            "dateAdded": "2024-01-15",
            "dueDate": "2024-02-15"
        }
    }
    assert vulnerabilitylookup.is_kev(vuln) is True


def test_is_kev_false():
    vuln = {}
    assert vulnerabilitylookup.is_kev(vuln) is False


def test_extract_kev_data():
    vuln = {
        "kev": {
            "dateAdded": "2024-01-15",
            "dueDate": "2024-02-15",
            "requiredAction": "Apply updates",
            "vulnerabilityName": "Critical RCE"
        }
    }
    result = vulnerabilitylookup.extract_kev_data(vuln)
    assert result["dateAdded"] == "2024-01-15"
    assert result["dueDate"] == "2024-02-15"
    assert result["requiredAction"] == "Apply updates"
    assert result["vulnerabilityName"] == "Critical RCE"


def test_extract_description():
    vuln = {
        "summary": "This is a test vulnerability description"
    }
    result = vulnerabilitylookup.extract_description(vuln)
    assert result == "This is a test vulnerability description"


def test_extract_cwes():
    vuln = {
        "cwe": ["79", "89"]
    }
    result = vulnerabilitylookup.extract_cwes(vuln)
    assert "CWE-79" in result
    assert "CWE-89" in result


def test_extract_references():
    vuln = {
        "references": [
            {
                "url": "https://example.com/advisory",
                "source": "vendor",
                "tags": ["Patch", "Vendor Advisory"]
            },
            {
                "url": "https://nvd.nist.gov/vuln/detail/CVE-2024-1234",
                "source": "NVD",
                "tags": []
            }
        ]
    }
    result = vulnerabilitylookup.extract_references(vuln)
    assert len(result) == 2
    assert result[0]["url"] == "https://example.com/advisory"
    assert result[0]["tags"] == ["Patch", "Vendor Advisory"]


def test_severity_from_score():
    assert vulnerabilitylookup._severity_from_score(9.5) == "Critical"
    assert vulnerabilitylookup._severity_from_score(8.0) == "High"
    assert vulnerabilitylookup._severity_from_score(5.0) == "Medium"
    assert vulnerabilitylookup._severity_from_score(2.0) == "Low"
    assert vulnerabilitylookup._severity_from_score(None) == "None"


def test_fetch_for_cpe_filters_by_date(monkeypatch):
    """Test that fetch_for_cpe filters results by date range."""
    now = datetime.now(timezone.utc)
    since = now - timedelta(days=2)
    until = now

    # Mock response with mixed dates in paginated format
    mock_vulns = [
        {"id": "CVE-2024-0001", "lastModified": (now - timedelta(days=1)).strftime("%Y-%m-%dT%H:%M:%S.000Z")},
        {"id": "CVE-2024-0002", "lastModified": (now - timedelta(days=5)).strftime("%Y-%m-%dT%H:%M:%S.000Z")},
        {"id": "CVE-2024-0003", "lastModified": now.strftime("%Y-%m-%dT%H:%M:%S.000Z")},
    ]

    class FakeResponse:
        status_code = 200

        def raise_for_status(self):
            pass

        def json(self):
            # Return paginated response format
            return {
                "data": mock_vulns,
                "metadata": {
                    "page": 1,
                    "per_page": 100,
                    "total_pages": 1
                }
            }

    def fake_get(session, path, insecure, params=None):
        return FakeResponse()

    monkeypatch.setattr(vulnerabilitylookup, "_do_get", fake_get)

    class FakeSession:
        pass

    results = vulnerabilitylookup.fetch_for_cpe(
        session=FakeSession(),
        cpe="cpe:2.3:a:test:test:1.0:*:*:*:*:*:*:*",
        since=since,
        until=until,
        insecure=False
    )

    # Should only include CVEs within the date range (not the one from 5 days ago)
    assert len(results) == 2
    assert results[0]["id"] == "CVE-2024-0001"
    assert results[1]["id"] == "CVE-2024-0003"


def test_fetch_for_cpe_handles_pagination(monkeypatch):
    """Test that fetch_for_cpe handles multi-page responses."""
    now = datetime.now(timezone.utc)
    since = now - timedelta(days=30)
    until = now

    page_responses = {
        1: {
            "data": [{"id": "CVE-2024-0001", "lastModified": now.strftime("%Y-%m-%dT%H:%M:%S.000Z")}],
            "metadata": {"page": 1, "per_page": 1, "total_pages": 2}
        },
        2: {
            "data": [{"id": "CVE-2024-0002", "lastModified": now.strftime("%Y-%m-%dT%H:%M:%S.000Z")}],
            "metadata": {"page": 2, "per_page": 1, "total_pages": 2}
        }
    }

    class FakeResponse:
        def __init__(self, page):
            self.page = page
            self.status_code = 200

        def raise_for_status(self):
            pass

        def json(self):
            return page_responses[self.page]

    def fake_get(session, path, insecure, params=None):
        page = params.get("page", 1) if params else 1
        return FakeResponse(page)

    monkeypatch.setattr(vulnerabilitylookup, "_do_get", fake_get)

    class FakeSession:
        pass

    results = vulnerabilitylookup.fetch_for_cpe(
        session=FakeSession(),
        cpe="cpe:2.3:a:test:test:1.0:*:*:*:*:*:*:*",
        since=since,
        until=until,
        insecure=False,
        fetch_all_pages=True
    )

    # Should fetch both pages
    assert len(results) == 2
    assert results[0]["id"] == "CVE-2024-0001"
    assert results[1]["id"] == "CVE-2024-0002"


def test_extract_vuln_date_nvd_format():
    """Test date extraction from NVD format vulnerability."""
    vuln = {"lastModified": "2024-01-15T12:00:00.000Z"}
    result = vulnerabilitylookup._extract_vuln_date(vuln)
    assert result is not None
    assert result.year == 2024
    assert result.month == 1
    assert result.day == 15


def test_extract_vuln_date_cve_metadata():
    """Test date extraction from cveMetadata format."""
    vuln = {
        "cveMetadata": {
            "dateUpdated": "2024-02-20T10:30:00.000Z"
        }
    }
    result = vulnerabilitylookup._extract_vuln_date(vuln)
    assert result is not None
    assert result.year == 2024
    assert result.month == 2
    assert result.day == 20
